	<table class="list kpi_calc">
	<caption><%= pattern_name(period) %></caption>
	<thead>
		<tr>
		<th><%= l(:label_kpi_indicators) %></th>
		<th><%= l(:label_mark_period) %></th>
		<th class="narrow"><%= l(:weight_label) %></th>
		<th class="narrow"><%= l(:label_plan) %></th>
		<th class="narrow"><%= l(:value_of_fact) %></th>
		<th class="narrow"><%= l(:percent_of_complete) %></th>
		</tr>
	</thead>
	<tbody>

	<% cat_avg_completion = {} %>

	<% j=0 %>
	<% period_user = period.kpi_period_users.where(:user_id => @user.id).first %>
	<% period.kpi_period_categories.each do |cat| %>
	

		<% color=cat.kpi_category.color %>
		<tr class="kpi_cat <%= color %>">
		<td colspan="2"><%= cat.kpi_category.name %></td>
		<td><%= kpi_percent cat.percent %></td>
		<td></td>
		<td></td>
		<td id="cat_completion_<%= i %>_<%= j %>"></td>
		</tr>
		<% y=0 %>
		<% indicator_avg_completion = {} %>

		<% cat.kpi_period_indicators.joins(:indicator).order("#{Indicator.table_name}.name").each do |period_indicator| %>

			<tr class="<%= color %> kpi_indicator">
			<td colspan="2"><%= link_to_indicator period_indicator.indicator %></td>
			<td><%= kpi_percent period_indicator.percent %></td>
			<td></td>
			<td></td>				
			<td id="indicator_completion_<%= i %>_<%= j %>_<%= y %>"></td>				
			</tr>
			<% marks = {} %>
			
			<% x=0 %>
			<% period_indicator.kpi_marks.select("kpi_marks.*").joins(:inspector).where("#{KpiMark.table_name}.user_id = ?", @user.id).order("#{User.table_name}.lastname").each do |mark| %>
				<tr class="<%= color %>">
				<td class="inspector"><%= link_to_user mark.inspector %></td>
				<td><%= mark.mark_period %> <small><%= link_to_modal_window l(:kpi_mark_desc), mark.explanation if mark.explanation.to_s!='' %></small></td>
				<td><%= kpi_percent mark.kpi_indicator_inspector.percent %> </td>
				<td><nobr><%= kpi_value plan_view(mark.plan(period_indicator), mark, period_indicator, period, period_user), 
								        period_indicator.kpi_unit.abridgement %></nobr></td>
				<td><nobr><%= kpi_value fact_view(mark, period, period_indicator, period_user), period_indicator.kpi_unit.abridgement %></nobr></td>		
				<% 
				completion = mark.completion(period_indicator)
				marks[mark] = completion unless completion.nil?
				 %>		
				<td><%= kpi_percent completion_view(mark, completion) %></td>
				</tr>
			<% x+=1 %>
			<% end %>

			<tr class="I">
			<td colspan="6">
			<div class="portable_data" data-target-id="indicator_completion_<%= i %>_<%= j %>_<%= y %>">
			<% indicator_avg_completion[period_indicator] = get_avg_completion(marks)  %>
			<%= kpi_percent indicator_avg_completion[period_indicator] %>	
			</div>
			</td>
			</tr>

		<% y+=1 %>
		<% end %>


		<tr class="I">
		<td colspan="6">
		<div class="portable_data" data-target-id="cat_completion_<%= i %>_<%= j %>">
			<% cat_avg_completion[cat] = weighted_average_value(indicator_avg_completion) %>
			<%= kpi_percent cat_avg_completion[cat] %>
		</div>
		</td>
		</tr>
	
	<% j+=1 %>
	<% end %>	
	
	</tbody></table>

	<div class="R">
	<span>
		<%= "<span class=\"selected\">#{l(:cacl_period_is_locked)}</span>".html_safe if period_user.locked? %>
		<% if period.for_closing_for_user?(@user) %>
			<% if  period_user.locked %>
				<%= link_to l(:reopen_period), {:controller => "kpi_calc_periods", :action => "reopen_for_user", :user_id => @user.id, :id => period.id}, :class => 'icon reopen_period' if User.current.admin? %>
			<% else  %>
				<%= link_to l(:close_period), {:controller => "kpi_calc_periods", :action => "close_for_user", :user_id => @user.id, :id => period.id}, :class => 'icon close_period'  %>
			<% end  %>
		<% end %>
	</span>
	<span class="kpi_factor">
	<% weighted_average_value = weighted_average_value(cat_avg_completion) %>
	<%= kpi_percent weighted_average_value %>
	</span>
	</div>

	<script>
	jQuery('div.modal_window').hide();
	</script>

